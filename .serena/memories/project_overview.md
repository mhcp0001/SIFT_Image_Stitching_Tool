# プロジェクト概要

## プロジェクト名
SIFT_Image_Stitching_Tool

## 目的
SIFT (Scale-Invariant Feature Transform) アルゴリズムを使用した画像合成ツール。広角のオーバービュー画像に、複数の高解像度クローズアップ画像を合成して、高品質な合成画像を生成する。

## 主要機能
1. **特徴点マッチング**: OpenCVのSIFTアルゴリズムで画像間の特徴点を検出・マッチング
2. **ホモグラフィ変換**: RANSACを使用してロバストな変換行列を計算
3. **ブレンディング**: ガウシアンブラーマスクを使用したスムーズな画像合成
4. **結果分析**: 合成画像の品質評価ツール付き

## アーキテクチャ

### 処理パイプライン
1. **初期化**: ログファイル作成、SIFT検出器初期化
2. **入力検証**: オーバービュー画像と複数のクローズアップ画像を読み込み
3. **キャンバス準備**: オーバービュー画像を3倍にアップスケール、ベースSIFT特徴量を計算
4. **合成ループ**: 各クローズアップ画像に対して:
   - SIFT特徴量を計算してベース画像とマッチング
   - ホモグラフィ変換を計算 (RANSAC使用)
   - クローズアップをキャンバス座標系にワープ
   - ガウシアンブラーマスクでブレンディング
5. **出力**: 合成画像を保存、処理統計をログに記録

### 主要パラメータ
- `CANVAS_SCALE = 3`: 最終出力の解像度倍率
- `STRENGTH = 31`: ブレンディング用ガウシアンブラーのカーネルサイズ（奇数）
- `SIFT_MIN_MATCHES = 12`: 有効なホモグラフィに必要な最小特徴点マッチ数
- `SIFT_RATIO_TEST = 0.75`: Loweの比率テスト閾値

## ファイル構造
- `src/main.py`: メインロジック（モノリシック実装、クラスなし）
- `tools/analyze_stitched.py`: 結果分析用スタンドアロンスクリプト
- `img/`: 入出力ディレクトリ（CWDからの相対パスでハードコード）
  - `img/overview.jpg`: 広角オーバービュー画像（入力）
  - `img/closeups/*.jpg`: クローズアップ画像群（入力）
  - `img/stitched.png`: 合成結果画像（出力）
  - `img/stitch.log`: 処理ログ（追記モード）
- `CLAUDE.md`: Claude Code向けプロジェクト指示
- `spec/`: 空のディレクトリ

## 設計パターン
- **グローバルSIFT検出器**: モジュールレベルで1回初期化、OpenCVバージョン対応のフォールバック付き
- **インプレースキャンバス更新**: メモリオーバーヘッド回避のため、キャンバスを直接変更
- **事前計算ベース特徴量**: ベース画像の特徴量（k1, d1）を1回計算し全クローズアップで再利用
- **座標系変換**: 2段階ホモグラフィ - (1) クローズアップ→ベース座標、(2) ベース→キャンバス座標（Hscale経由）

## 入出力
- **入力**: `img/overview.jpg`（必須）、`img/closeups/*.jpg`（1枚以上）
- **出力**: `img/stitched.png`、`img/stitch.log`（追記）
- **実行ディレクトリ**: リポジトリルートから実行する必要あり
