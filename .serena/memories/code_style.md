# コーディングスタイルと規約

## 言語・コメント
- **コメント言語**: 日本語
- **docstring**: 日本語、Google styleに準拠
  ```python
  def setup_logging():
      """
      ログファイルを初期化し、グローバルファイルハンドルを設定し、開始時刻を書き込む。
      """
  ```

## 命名規約

### 定数
- **スタイル**: 大文字スネークケース（UPPER_SNAKE_CASE）
- **例**: `CANVAS_SCALE`, `SIFT_MIN_MATCHES`, `OVERVIEW`, `OUT`
- **配置**: ファイル先頭のモジュールレベルで定義

### 関数
- **スタイル**: 小文字スネークケース（lower_snake_case）
- **例**: `setup_logging()`, `write_log()`, `homography_sift()`, `warp_and_blend()`

### 変数
- **スタイル**: 小文字スネークケース
- **例**: `base`, `canvas`, `closeups_paths`, `success_count`

### グローバル変数
- **スタイル**: 小文字スネークケース
- **例**: `log_f`, `sift`
- **注意**: グローバル変数は最小限（ログファイルハンドルとSIFT検出器のみ）

## 型ヒント
- **使用**: 部分的に使用
- **例**: 
  ```python
  def write_log(message: str):
  ```
- **範囲**: 関数引数に型ヒントあり、戻り値の型ヒントは省略傾向

## コード構造

### ファイル構成
1. インポート文
2. 定数定義（ファイルI/O、処理パラメータ）
3. グローバル変数
4. 関数定義（ロギング、コアロジック）
5. main関数
6. `if __name__ == "__main__":` エントリーポイント

### モジュール設計
- **アプローチ**: モノリシック単一ファイル
- **クラス**: 使用しない（関数ベース）
- **モジュール分割**: なし（src/main.pyに全ロジック集約）

## エラーハンドリング
- **スタイル**: try-except-elseパターン
- **ロギング**: 全エラーメッセージを`write_log()`経由でログ記録
- **致命的エラー**: `sys.exit(1)`で即座に終了
  - オーバービュー画像読み込み失敗
  - クローズアップ画像が見つからない
  - SIFT特徴量計算失敗
- **非致命的エラー**: ログ記録してスキップ、処理継続
  - 個別クローズアップの読み込み失敗
  - ホモグラフィ計算失敗
  - ブレンディングエラー

## ロギング戦略
- **デュアル出力**: すべてのメッセージをコンソール（print）とログファイルの両方に出力
- **ファイルモード**: 追記モード（'a'）
- **フラッシュ**: 書き込みごとにflush（クラッシュ時のリカバリ用）
- **メッセージフォーマット**:
  - `[INFO]`: 通常の情報メッセージ
  - `[blend]`: クローズアップ合成成功
  - `[skip]`: クローズアップスキップ（失敗）
  - `[ERROR]`: エラーメッセージ
  - `[DEBUG]`: デバッグ情報
  - `[CRITICAL ERROR]`: 致命的エラー

## コーディングパターン

### 配列操作
- **float32変換**: 精度損失回避のため、ブレンディング計算はfloat32で実行
  ```python
  canvas_float = canvas.astype(np.float32)
  # 計算...
  canvas[:] = np.clip(blended, 0, 255).astype(np.uint8)
  ```

### インプレース更新
- **キャンバス更新**: `canvas[:] = ...` でインプレース更新
- **メリット**: メモリオーバーヘッド削減

### 互換性対応
- **OpenCVバージョン**: try-exceptチェーンでフォールバック
- **奇数カーネル**: ブレンディング強度が偶数の場合は+1して奇数化

## フォーマット
- **インデント**: スペース4個
- **行長**: 厳密な制限なし（80文字を超える行あり）
- **改行**: 適度な空白行でセクション分離
- **文字列**: ダブルクォート優先、f-string使用

## ドキュメント
- **README.md**: ほぼ空（タイトルのみ）
- **CLAUDE.md**: 詳細なプロジェクト説明（Claude Code向け）
- **コメント**: コードセクションごとにコメントあり（例: `# --- 2. ファイルI/Oとパス (固定値) ---`）
